<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Memory Handoff Hub</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
    textarea { width: 95%; height: 250px; margin-bottom: 10px; }
    button { padding: 10px 15px; background-color: #007BFF; color: white; border: none; cursor: pointer; }
    #status { margin-top: 15px; font-weight: bold; }
    .doc-link { margin-top: 20px; }
    .panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .panel h3 { margin-top: 0; }
    .sync-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .sync-label { font-weight: bold; }
    .scope-options label { margin-right: 15px; }
    select { padding: 6px; }
    .subtle { font-size: 0.9em; color: #555; }
    #teamSelectContainer { margin-top: 10px; }
    #categoryInfo { margin-top: 8px; font-size: 0.9em; color: #333; }
  </style>
</head>
<body>
  <h2>ğŸ§  Memory Handoff Hub (v2.2)</h2>
  
  <p>Gemini/ChatGPTì—ì„œ ìƒì„±í•œ [HANDOFF] ë¸”ë¡ì„ ì•„ë˜ì— ë¶™ì—¬ë„£ê³  [GDocì— ì €ì¥] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>

  <div class="panel">
    <h3>ëŒ€ìƒ ë¬¸ì„œ ì„ íƒ</h3>
    <div class="scope-options">
      <label><input type="radio" name="scope" value="personal" checked> ê°œì¸ìš©</label>
      <label><input type="radio" name="scope" value="team"> íŒ€ìš©</label>
    </div>
    <div id="teamSelectContainer">
      <span class="sync-label">íŒ€ ì„ íƒ:</span>
      <select id="teamSelect" disabled>
        <option value="">ë“±ë¡ëœ íŒ€ ì—†ìŒ</option>
      </select>
    </div>
  </div>

  <div class="panel">
    <h3>ì„¸ì…˜ ë™ê¸°í™”</h3>
    <div class="sync-row">
      <div class="sync-label">Revision:</div>
      <div id="revisionValue">-</div>
    </div>
    <div class="sync-row">
      <div class="sync-label">Last Updated:</div>
      <div id="lastUpdatedValue">-</div>
    </div>
    <button onclick="refreshMetadata()">ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>
  
  <textarea id="handoffText" placeholder="[HANDOFF]... ë¸”ë¡ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
  <br>
  <button onclick="saveHandoff()">GDocì— ì €ì¥</button>
  <button onclick="openDoc()">ë¬¸ì„œ ì—´ê¸°</button>
  
  <div id="status"></div>
  <div class="doc-link"><a id="docLink" href="#" target="_blank"></a></div>
  <div id="categoryInfo" class="subtle"></div>

  <script>
    let currentRevision = '';
    let currentScope = 'personal';
    let currentTeamKey = '';
    let teamOptions = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ GDoc ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Cë‹˜ì˜ getDocInfo() í˜¸ì¶œ)
    document.addEventListener("DOMContentLoaded", function() {
      setupScopeListeners();
      loadTeamOptions(function() {
        refreshMetadata();
      });
    });

    function setupScopeListeners() {
      document.querySelectorAll('input[name="scope"]').forEach(function(input) {
        input.addEventListener('change', function(event) {
          currentScope = event.target.value;
          if (currentScope !== 'team') {
            currentTeamKey = '';
          } else if (!currentTeamKey && teamOptions.length) {
            currentTeamKey = teamOptions[0].key;
          }
          updateTeamSelectState();
          refreshMetadata();
        });
      });

      document.getElementById("teamSelect").addEventListener('change', function(event) {
        currentTeamKey = event.target.value;
        refreshMetadata();
      });
    }

    function loadTeamOptions(callback) {
      google.script.run.withSuccessHandler(function(list) {
        teamOptions = list || [];
        renderTeamSelect();
        if (typeof callback === "function") callback();
      }).withFailureHandler(function(err) {
        document.getElementById("status").innerText = "âš ï¸ íŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + err.message;
        if (typeof callback === "function") callback();
      }).getTeamList();
    }

    function renderTeamSelect() {
      const container = document.getElementById("teamSelectContainer");
      const select = document.getElementById("teamSelect");
      select.innerHTML = "";

      if (!teamOptions.length) {
        container.style.display = 'none';
        currentTeamKey = '';
        return;
      }

      container.style.display = 'block';
      teamOptions.forEach(function(team, idx) {
        const option = document.createElement("option");
        option.value = team.key;
        option.textContent = team.key;
        select.appendChild(option);
      });

      if (!currentTeamKey || !teamOptions.some(function(team) { return team.key === currentTeamKey; })) {
        currentTeamKey = teamOptions[0].key;
      }
      select.value = currentTeamKey;
      updateTeamSelectState();
    }

    function updateTeamSelectState() {
      const select = document.getElementById("teamSelect");
      const container = document.getElementById("teamSelectContainer");
      const disabled = currentScope !== 'team';
      select.disabled = disabled;
      container.style.opacity = disabled ? 0.5 : 1;
    }

    function refreshMetadata() {
      if (currentScope === 'team' && !currentTeamKey) {
        document.getElementById("status").innerText = "âš ï¸ íŒ€ ë¬¸ì„œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ íŒ€ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”.";
        return;
      }
      document.getElementById("status").innerText = "ë™ê¸°í™” ì¤‘...";
      google.script.run.withSuccessHandler(function(info) {
        if (info.error) {
          document.getElementById("status").innerText = "âŒ ë©”íƒ€ë°ì´í„° ì˜¤ë¥˜: " + info.error;
          return;
        }
        currentRevision = info.revisionId || '';
        document.getElementById("docLink").href = info.url;
        const scopeTag = info.scope === 'team' ? ("íŒ€:" + (info.teamKey || '?')) : "ê°œì¸";
        document.getElementById("docLink").innerText = "Â» [" + scopeTag + "] " + info.name + " ì—´ê¸°";
        document.getElementById("revisionValue").innerText = currentRevision || '-';
        document.getElementById("lastUpdatedValue").innerText = info.lastUpdated || '-';
        document.getElementById("status").innerText = "âœ… ìµœì‹  ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.";
        renderCategories([]);
      }).withFailureHandler(function(err) {
        document.getElementById("status").innerText = "âŒ ë©”íƒ€ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message;
      }).getDocInfo(currentScope, currentTeamKey);
    }

    // í•¸ë“œì˜¤í”„ ì €ì¥ (Cë‹˜ì˜ doPost() í˜¸ì¶œ)
    function saveHandoff() {
      if (!currentRevision) {
        document.getElementById("status").innerText = "âš ï¸ ë¨¼ì € [ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¡œ ë™ê¸°í™”í•˜ì„¸ìš”.";
        return;
      }
      if (currentScope === 'team' && !currentTeamKey) {
        document.getElementById("status").innerText = "âš ï¸ íŒ€ ë¬¸ì„œ ì €ì¥ ì „ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.";
        return;
      }
      document.getElementById("status").innerText = "ì €ì¥ ì¤‘...";
      var text = document.getElementById("handoffText").value;
      google.script.run
        .withSuccessHandler(function(response) {
          handleSaveResponse(response);
        })
        .withFailureHandler(function(err) {
          document.getElementById("status").innerText = "âŒ ì €ì¥ ì‹¤íŒ¨: " + err.message;
        })
        .syncHandoff(text, currentRevision, currentScope, currentTeamKey);
    }

    function openDoc() {
      window.open(document.getElementById("docLink").href);
    }

    function handleSaveResponse(response) {
      if (!response || !response.status) {
        document.getElementById("status").innerText = "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µì…ë‹ˆë‹¤.";
        return;
      }

      if (response.status === 'CONFLICT') {
        document.getElementById("status").innerText = "âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¨¼ì € ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë™ê¸°í™” í›„ ì‹œë„í•˜ì„¸ìš”.";
        refreshMetadata();
        return;
      }

      if (response.status === 'MISSING_REVISION') {
        document.getElementById("status").innerText = "âš ï¸ ë¦¬ë¹„ì „ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. [ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.";
        refreshMetadata();
        return;
      }

      if (response.status === 'LOCK_TIMEOUT') {
        document.getElementById("status").innerText = "â³ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”. í˜„ì¬ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤.";
        return;
      }

      if (response.status === 'OK') {
        document.getElementById("status").innerText = "âœ… ì €ì¥ ì„±ê³µ!";
        document.getElementById("handoffText").value = "";
      } else {
        document.getElementById("status").innerText = "âš ï¸ ìƒíƒœ: " + response.status;
      }

      if (response.revisionId) {
        currentRevision = response.revisionId;
        document.getElementById("revisionValue").innerText = currentRevision;
      }
      if (response.last_updated) {
        document.getElementById("lastUpdatedValue").innerText = response.last_updated;
      }
      if (response.categories) {
        renderCategories(response.categories);
      }
    }

    function renderCategories(categories) {
      const el = document.getElementById("categoryInfo");
      if (!categories || !categories.length) {
        el.innerText = "";
        return;
      }
      el.innerText = "ìë™ íƒœê·¸: " + categories.join(", ");
    }
  </script>
</body>
</html>

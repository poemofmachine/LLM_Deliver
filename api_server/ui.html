<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Memory Handoff Hub</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
    textarea { width: 95%; height: 250px; margin-bottom: 10px; }
    button { padding: 10px 15px; background-color: #007BFF; color: white; border: none; cursor: pointer; border-radius: 6px; }
    #status { margin-top: 15px; font-weight: bold; }
    .doc-link { margin-top: 20px; }
    .panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .panel h3 { margin-top: 0; }
    .sync-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .sync-label { font-weight: bold; }
    .scope-options label { margin-right: 15px; }
    select { padding: 6px; }
    .subtle { font-size: 0.9em; color: #555; }
    #teamSelectContainer { margin-top: 10px; }
    #categoryInfo { margin-top: 8px; font-size: 0.9em; color: #333; }
    .info-panel { display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap; }
    .info-steps { margin: 0; padding-left: 18px; font-size: 0.95em; }
    .guide-link { background-color: #28a745; }
    .secondary { background-color: #6c757d; }
    .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .guide-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: flex; align-items: center; justify-content: center; z-index: 999; }
    .guide-card { background: #fff; border-radius: 12px; padding: 20px; width: 95%; max-width: 520px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
    .guide-card h3 { margin-top: 0; }
    .guide-card ol { padding-left: 20px; }
    .guide-card footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>ğŸ§  Memory Handoff Hub (v2.2)</h2>
  
  <p>Gemini/ChatGPTì—ì„œ ìƒì„±í•œ [HANDOFF] ë¸”ë¡ì„ ì•„ë˜ì— ë¶™ì—¬ë„£ê³  [GDocì— ì €ì¥] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
  <div class="panel info-panel">
    <div>
      <strong>ë¹ ë¥¸ ìˆœì„œ</strong>
      <ol class="info-steps">
        <li>ëŒ€ìƒ ë¬¸ì„œ(ê°œì¸/íŒ€)ì™€ íŒ€ í‚¤ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</li>
        <li>[ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¡œ ë¦¬ë¹„ì „ì„ ë§ì¶¥ë‹ˆë‹¤.</li>
        <li>ì•„ë˜ì— [HANDOFF]ë¥¼ ë¶™ì—¬ë„£ê³  ì €ì¥í•©ë‹ˆë‹¤.</li>
      </ol>
    </div>
    <div class="action-buttons">
      <button class="guide-link" onclick="toggleGuide(true)">ğŸ§­ ê°€ì´ë“œ ëª¨ë“œ</button>
      <button class="secondary" onclick="copyDocUrl()">URL ë³µì‚¬</button>
    </div>
  </div>

  <div class="panel">
    <h3>ëŒ€ìƒ ë¬¸ì„œ ì„ íƒ</h3>
    <div class="scope-options">
      <label><input type="radio" name="scope" value="personal" checked> ê°œì¸ìš©</label>
      <label><input type="radio" name="scope" value="team"> íŒ€ìš©</label>
    </div>
    <div id="teamSelectContainer">
      <span class="sync-label">íŒ€ ì„ íƒ:</span>
      <select id="teamSelect" disabled>
        <option value="">ë“±ë¡ëœ íŒ€ ì—†ìŒ</option>
      </select>
    </div>
  </div>

  <div class="panel">
    <h3>ì„¸ì…˜ ë™ê¸°í™”</h3>
    <div class="sync-row">
      <div class="sync-label">Revision:</div>
      <div id="revisionValue">-</div>
    </div>
    <div class="sync-row">
      <div class="sync-label">Last Updated:</div>
      <div id="lastUpdatedValue">-</div>
    </div>
    <button onclick="refreshMetadata()">ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>
  
  <textarea id="handoffText" placeholder="[HANDOFF]... ë¸”ë¡ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
  <br>
  <button onclick="saveHandoff()">GDocì— ì €ì¥</button>
  <button onclick="openDoc()">ë¬¸ì„œ ì—´ê¸°</button>
  
  <div id="status"></div>
  <div id="wizardTips" class="subtle"></div>
  <div class="doc-link"><a id="docLink" href="#" target="_blank"></a></div>
  <div id="categoryInfo" class="subtle"></div>
  <div id="guideOverlay" class="guide-overlay hidden">
    <div class="guide-card">
      <h3>ê°€ì´ë“œ ëª¨ë“œ</h3>
      <p>ì¼ë°˜ ì‚¬ìš©ìë„ 3ë‹¨ê³„ ë£¨í‹´ë§Œ ìµíˆë©´ ë©ë‹ˆë‹¤. í•„ìš”í•œ í•­ëª©ì„ ì„ íƒí•˜ë©´ ë°”ë¡œ í™”ë©´ì´ ì„¸íŒ…ë©ë‹ˆë‹¤.</p>
      <ol>
        <li><strong>ëŒ€ìƒ ë¬¸ì„œ:</strong> ê°œì¸ìš©ì€ ê¸°ë³¸ê°’, íŒ€ ë‹¨ìœ„ë¼ë©´ íŒ€ì„ ê³ ë¥´ì„¸ìš”.</li>
        <li><strong>ìµœì‹  ë¦¬ë¹„ì „ ë°›ê¸°:</strong> [ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆ„ë¥´ë©´ ì¶©ëŒì„ ì˜ˆë°©í•©ë‹ˆë‹¤.</li>
        <li><strong>[HANDOFF] ë¶™ì—¬ë„£ê¸°:</strong> í…ìŠ¤íŠ¸ë¥¼ ë„£ê³  [GDocì— ì €ì¥]ì„ ëˆ„ë¥´ë©´ ë!</li>
      </ol>
      <footer>
        <button class="secondary" onclick="toggleGuide(false)">ë‹«ê¸°</button>
        <button onclick="startWizard('personal')">ê°œì¸ìš© ì‹œì‘</button>
        <button onclick="startWizard('team')">íŒ€ìš© ì‹œì‘</button>
      </footer>
    </div>
  </div>

  <script>
    let currentRevision = '';
    let currentScope = 'personal';
    let currentTeamKey = '';
    let teamOptions = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ GDoc ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Cë‹˜ì˜ getDocInfo() í˜¸ì¶œ)
    document.addEventListener("DOMContentLoaded", function() {
      setupScopeListeners();
      loadTeamOptions(function() {
        refreshMetadata();
      });
    });

    function setupScopeListeners() {
      document.querySelectorAll('input[name="scope"]').forEach(function(input) {
        input.addEventListener('change', function(event) {
          currentScope = event.target.value;
          if (currentScope !== 'team') {
            currentTeamKey = '';
          } else if (!currentTeamKey && teamOptions.length) {
            currentTeamKey = teamOptions[0].key;
          }
          updateTeamSelectState();
          refreshMetadata();
        });
      });

      document.getElementById("teamSelect").addEventListener('change', function(event) {
        currentTeamKey = event.target.value;
        refreshMetadata();
      });
    }

    function loadTeamOptions(callback) {
      google.script.run.withSuccessHandler(function(list) {
        teamOptions = list || [];
        renderTeamSelect();
        if (typeof callback === "function") callback();
      }).withFailureHandler(function(err) {
        document.getElementById("status").innerText = "âš ï¸ íŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + err.message;
        if (typeof callback === "function") callback();
      }).getTeamList();
    }

    function renderTeamSelect() {
      const container = document.getElementById("teamSelectContainer");
      const select = document.getElementById("teamSelect");
      select.innerHTML = "";

      if (!teamOptions.length) {
        container.style.display = 'none';
        currentTeamKey = '';
        return;
      }

      container.style.display = 'block';
      teamOptions.forEach(function(team, idx) {
        const option = document.createElement("option");
        option.value = team.key;
        option.textContent = team.key;
        select.appendChild(option);
      });

      if (!currentTeamKey || !teamOptions.some(function(team) { return team.key === currentTeamKey; })) {
        currentTeamKey = teamOptions[0].key;
      }
      select.value = currentTeamKey;
      updateTeamSelectState();
    }

    function updateTeamSelectState() {
      const select = document.getElementById("teamSelect");
      const container = document.getElementById("teamSelectContainer");
      const disabled = currentScope !== 'team';
      select.disabled = disabled;
      container.style.opacity = disabled ? 0.5 : 1;
    }

    function refreshMetadata() {
      if (currentScope === 'team' && !currentTeamKey) {
        document.getElementById("status").innerText = "âš ï¸ íŒ€ ë¬¸ì„œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ íŒ€ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”.";
        return;
      }
      document.getElementById("status").innerText = "ë™ê¸°í™” ì¤‘...";
      google.script.run.withSuccessHandler(function(info) {
        if (info.error) {
          document.getElementById("status").innerText = "âŒ ë©”íƒ€ë°ì´í„° ì˜¤ë¥˜: " + info.error;
          return;
        }
        currentRevision = info.revisionId || '';
        document.getElementById("docLink").href = info.url;
        const scopeTag = info.scope === 'team' ? ("íŒ€:" + (info.teamKey || '?')) : "ê°œì¸";
        document.getElementById("docLink").innerText = "Â» [" + scopeTag + "] " + info.name + " ì—´ê¸°";
        document.getElementById("revisionValue").innerText = currentRevision || '-';
        document.getElementById("lastUpdatedValue").innerText = info.lastUpdated || '-';
        document.getElementById("status").innerText = "âœ… ìµœì‹  ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.";
        setWizardTip("ë¦¬ë¹„ì „ì„ ë§ì·„ìŠµë‹ˆë‹¤. [HANDOFF]ë¥¼ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš”.");
        renderCategories([]);
      }).withFailureHandler(function(err) {
        document.getElementById("status").innerText = "âŒ ë©”íƒ€ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message;
        setWizardTip("ì˜¤ë¥˜ê°€ ê³„ì†ë˜ë©´ í† í°/ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
      }).getDocInfo(currentScope, currentTeamKey);
    }

    // í•¸ë“œì˜¤í”„ ì €ì¥ (Cë‹˜ì˜ doPost() í˜¸ì¶œ)
    function saveHandoff() {
      if (!currentRevision) {
        document.getElementById("status").innerText = "âš ï¸ ë¨¼ì € [ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¡œ ë™ê¸°í™”í•˜ì„¸ìš”.";
        return;
      }
      if (currentScope === 'team' && !currentTeamKey) {
        document.getElementById("status").innerText = "âš ï¸ íŒ€ ë¬¸ì„œ ì €ì¥ ì „ íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.";
        return;
      }
      document.getElementById("status").innerText = "ì €ì¥ ì¤‘...";
      var text = document.getElementById("handoffText").value;
      google.script.run
        .withSuccessHandler(function(response) {
          handleSaveResponse(response);
        })
        .withFailureHandler(function(err) {
          document.getElementById("status").innerText = "âŒ ì €ì¥ ì‹¤íŒ¨: " + err.message;
        })
        .syncHandoff(text, currentRevision, currentScope, currentTeamKey);
    }

    function openDoc() {
      window.open(document.getElementById("docLink").href);
    }

    function handleSaveResponse(response) {
      if (!response || !response.status) {
        document.getElementById("status").innerText = "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µì…ë‹ˆë‹¤.";
        return;
      }

      if (response.status === 'CONFLICT') {
        document.getElementById("status").innerText = "âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¨¼ì € ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë™ê¸°í™” í›„ ì‹œë„í•˜ì„¸ìš”.";
        setWizardTip("ë¦¬ë¹„ì „ì´ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤. [ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        refreshMetadata();
        return;
      }

      if (response.status === 'MISSING_REVISION') {
        document.getElementById("status").innerText = "âš ï¸ ë¦¬ë¹„ì „ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. [ìµœì‹  ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.";
        setWizardTip("ë¦¬ë¹„ì „ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. Step 2ë¥¼ ë‹¤ì‹œ ìˆ˜í–‰í•˜ì„¸ìš”.");
        refreshMetadata();
        return;
      }

      if (response.status === 'LOCK_TIMEOUT') {
        document.getElementById("status").innerText = "â³ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”. í˜„ì¬ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤.";
        setWizardTip("ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ë’¤ ì¬ì‹œë„í•˜ì„¸ìš”.");
        return;
      }

      if (response.status === 'OK') {
        document.getElementById("status").innerText = "âœ… ì €ì¥ ì„±ê³µ!";
        document.getElementById("handoffText").value = "";
        setWizardTip("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê°™ì€ ì ˆì°¨ë¡œ ë‹¤ìŒ ì„¸ì…˜ì„ ê¸°ë¡í•˜ì„¸ìš”.");
      } else {
        document.getElementById("status").innerText = "âš ï¸ ìƒíƒœ: " + response.status;
      }

      if (response.revisionId) {
        currentRevision = response.revisionId;
        document.getElementById("revisionValue").innerText = currentRevision;
      }
      if (response.last_updated) {
        document.getElementById("lastUpdatedValue").innerText = response.last_updated;
      }
      if (response.categories) {
        renderCategories(response.categories);
      }
    }

    function renderCategories(categories) {
      const el = document.getElementById("categoryInfo");
      if (!categories || !categories.length) {
        el.innerText = "";
        return;
      }
      el.innerText = "ìë™ íƒœê·¸: " + categories.join(", ");
    }

    function toggleGuide(show) {
      const overlay = document.getElementById("guideOverlay");
      overlay.classList.toggle("hidden", show === false);
      if (show) {
        overlay.classList.remove("hidden");
      }
    }

    function setWizardTip(text) {
      const el = document.getElementById("wizardTips");
      el.innerText = text || "";
    }

    function startWizard(scope) {
      toggleGuide(false);
      setScope(scope);
      const stepText = scope === 'team'
        ? "íŒ€ ë¬¸ì„œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. íŒ€ í‚¤ë¥¼ ê³ ë¥¸ ë’¤ ìµœì‹  ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”."
        : "ê°œì¸ ë¬¸ì„œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ìµœì‹  ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.";
      setWizardTip(stepText);
      if (scope === 'team' && !currentTeamKey && teamOptions.length) {
        currentTeamKey = teamOptions[0].key;
        document.getElementById("teamSelect").value = currentTeamKey;
      }
      refreshMetadata();
    }

    function setScope(scope) {
      const input = document.querySelector(`input[name="scope"][value="${scope}"]`);
      if (input) {
        input.checked = true;
        currentScope = scope;
        currentTeamKey = scope === 'team' ? currentTeamKey : '';
        updateTeamSelectState();
      }
    }

    function copyDocUrl() {
      const link = document.getElementById("docLink").href;
      if (!link) {
        document.getElementById("status").innerText = "âš ï¸ ë¨¼ì € ìµœì‹  ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.";
        return;
      }
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(link).then(function() {
          document.getElementById("status").innerText = "ğŸ“‹ ë¬¸ì„œ URLì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.";
        }).catch(function() {
          fallbackCopy(link);
        });
      } else {
        fallbackCopy(link);
      }
    }

    function fallbackCopy(text) {
      const tmp = document.createElement("textarea");
      tmp.value = text;
      document.body.appendChild(tmp);
      tmp.select();
      try {
        document.execCommand("copy");
        document.getElementById("status").innerText = "ğŸ“‹ ë¬¸ì„œ URLì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.";
      } catch (err) {
        document.getElementById("status").innerText = "âš ï¸ URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err;
      } finally {
        document.body.removeChild(tmp);
      }
    }
  </script>
</body>
</html>
